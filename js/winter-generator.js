$.fn.random = function() {
return this.eq(Math.floor(Math.random() * this.length));
}
const dataimport = {"exportData":{"MFK403Nanowne":{"id":"MFK403Nanowne","name":"Sir Nanowne","title":"","birth":"403","death":"432","spouse":"FFN403Morchades","fatherID":"M2","motherID":"M1","relationship":"Great grandfather"},"FFN403Morchades":{"id":"FFN403Morchades","name":"Morchades","title":"","birth":"403","death":"431","spouse":"MFK403Nanowne","fatherID":0,"motherID":0,"relationship":"Great grandmother"},"MFK408Goneries":{"id":"MFK408Goneries","name":"Sir Goneries","title":"","birth":"408","death":"440","spouse":"FFN408Sangive","fatherID":"MFK403Nanowne","motherID":"FFN403Morchades","relationship":"Grandfather"},"FFN408Sangive":{"id":"FFN408Sangive","name":"Sangive","title":"","birth":"408","death":"489","spouse":"MFK408Goneries","fatherID":0,"motherID":0,"relationship":"Grandmother"},"MFK439Bersules":{"id":"MFK439Bersules","name":"Sir Bersules","title":"the Bald","birth":"439","death":"473","spouse":"FFN441Iblis","fatherID":"MFK408Goneries","motherID":"FFN408Sangive","relationship":"father"},"FFN441Iblis":{"id":"FFN441Iblis","name":"Iblis","title":"","birth":"441","death":"","spouse":"MFK439Bersules","fatherID":0,"motherID":0,"relationship":"mother"},"MTK459Hebes":{"id":"MTK459Hebes","name":"Sir Hebes","title":"","birth":"459","death":"","spouse":0,"fatherID":"MFK439Bersules","motherID":"FFN441Iblis","relationship":"Your illegitimate brother"},"MTK458Berel":{"id":"MTK458Berel","name":"Sir Berel","title":"","birth":"458","death":"","spouse":0,"fatherID":"MFK439Bersules","motherID":"FFN441Iblis","relationship":"Your illegitimate brother"},"MTK457Sauseise":{"id":"MTK457Sauseise","name":"Sir Sauseise","title":"","birth":"457","death":"","spouse":0,"fatherID":"MFK439Bersules","motherID":"FFN441Iblis","relationship":"Your illegitimate brother"},"MTK463Garnish":{"id":"MTK463Garnish","name":"Sir Garnish","title":"","birth":"463","death":"","spouse":0,"fatherID":"MFK439Bersules","motherID":"FFN441Iblis","relationship":"Your illegitimate brother"},"FFN466Cunneware":{"id":"FFN466Cunneware","name":"Cunneware","title":"","birth":"466","death":"","spouse":0,"fatherID":"MFK439Bersules","motherID":"FFN441Iblis","relationship":"Sister"},"FFN467Calire":{"id":"FFN467Calire","name":"Calire","title":"","birth":"467","death":"","spouse":0,"fatherID":"MFK439Bersules","motherID":"FFN441Iblis","relationship":"Sister"},"MFN439Hervis":{"id":"MFN439Hervis","name":"Hervis","title":"","birth":"439","death":"","spouse":0,"fatherID":"MFK408Goneries","motherID":"FFN408Sangive","relationship":"Paternal Uncle"},"MFK464Gherard":{"id":"MFK464Gherard","name":"Sir Gherard","title":"","birth":"464","death":"","spouse":0,"fatherID":"MFN439Hervis","motherID":0,"relationship":"Cousin through Hervis "},"MFK463Clegis":{"id":"MFK463Clegis","name":"Sir Clegis","title":"","birth":"463","death":"","spouse":0,"fatherID":"MFN439Hervis","motherID":0,"relationship":"Cousin through Hervis "},"MFK463Floridas":{"id":"MFK463Floridas","name":"Sir Floridas","title":"Caer Caradduc","birth":"463","death":"","spouse":0,"fatherID":"MFN439Hervis","motherID":0,"relationship":"Cousin through Hervis "},"MTK413Breunis":{"id":"MTK413Breunis","name":"Sir Breunis","title":"the Valiant","birth":"413","death":"","spouse":0,"fatherID":"MFK403Nanowne","motherID":"FFN403Morchades","relationship":"Grandfather's Illegitimate Brother"},"MFN441Gerin":{"id":"MFN441Gerin","name":"Gerin","title":"","birth":"441","death":"","spouse":"FFN461Cunneware","fatherID":"Grandfather","motherID":"Grandmother","relationship":"Maternal Uncle"},"FFN461Cunneware":{"id":"FFN461Cunneware","name":"Cunneware","title":"","birth":"461","death":"","spouse":"MFN441Gerin","fatherID":0,"motherID":0,"relationship":"Maternal Uncle"},"MFK457Bliant":{"id":"MFK457Bliant","name":"Sir Bliant","title":"","birth":"457","death":"","spouse":0,"fatherID":"MFN441Gerin","motherID":"FFN461Cunneware","relationship":"Cousin through Gerin "}},"ggfather":{"deathyear":432,"glory":1300,"name":"Nanowne","birthyear":403},"gfather":{"birthyear":408,"deathyear":440,"knightyear":433,"glory":1173,"loyal":true,"name":"Goneries"},"father":{"name":"Bersules","deathyear":473,"birthyear":439,"knightyear":0,"glory":1307,"wife":"Iblis","wifeborn":441},"yourAge":21,"manor":{"name":"Stapleford","oldKnights":1,"midKnights":0,"youngKnights":8,"lineageFighters":12,"levy":43},"extendedFamily":{"knights":[["Sir Breunis the Valiant","Grandfather's Illegitimate Brother",72,1],["Sir Sauseise ","Your illegitimate brother",28,3457],["Sir Berel ","Your illegitimate brother",27,3458],["Sir Hebes ","Your illegitimate brother",26,3459],["Sir Garnish ","Your illegitimate brother",22,3463],["Sir Gherard ","Hervis 's son",21,5439],["Sir Clegis ","Hervis 's son",22,5439],["Sir Floridas Caer Caradduc","Hervis 's son",22,5439],["Sir Bliant ","Gerin 's son",28,5441]],"others":[["Iblis","Sir Bersules's wife",44],["Hervis","Paternal uncle",46],["Iblis","Maternal aunt",44],["Bersules","Iblis's husband",46],["Gerin","Maternal uncle",44],["Cunneware","Gerin's wife",24]]},"familyhistory":{"historybyyear":[["408","Goneries your grandfather is born",""],["432","Death of your great-grandfather Nanowne",""],["433","Goneries knighted by Count Reginald of Salisbury and swears fealty to King Constantin.",""],["439","Birth of your father Bersules",""],["439","Battle of Carlion",""],["439","Goneries fought in the Battle of Carlion",""],["440","Death of Constantin",""],["440","Death of Goneries","Died in a Pict raid"],["460","Bersules knighted.",""],["463","Night of the Long Knives",""],["464","Bersules maries Iblis",""],["465","You are born",""],["466","Siege of Carlion",""],["466","Bersules fought in the Siege of Carlion",""],["468","Vortigern Defeated",""],["468","Bersules fought in the Fall of Carlion",""],["473","Saxons invade Windsor",""],["473","Death of Bersules","Died in Battle of Windsor"],["485","Campaign Year","You are knighted"]]},"template":{"name":"","id":"2.440.jon","dad":"2.440.jon","birthyear":0,"deathyear":0,"gender":"male","bastard":false,"spousename":"","spousebirthyear":0,"spousedeathyear":0}};
const treeMemberMarkup = '<span id="[id]" class="[individualClass]"><span class="famName">[name]</span><br><span class="knightTitle">[title]</span>&nbsp;<br><small><span class="birthYear">[birth]</span>-<span class="deathYear">[death]</span></small></span>';
pendragonWinterPhase ={
	data : {
        name: ["Adtherp", "Alein", "Aliduke", "Annecians", "Archade", "Arnold",
            "Arrouse", "Bandelaine", "Bellangere", "Bellias", "Berel", "Bersules",
            "Bliant", "Breunis", "Briant", "Caulas", "Chestelaine", "Clegis",
            "Cleremond", "Dalan", "Dinaunt", "Driant", "Ebel", "Edward", "Elias",
            "Eliot", "Emerause", "Flannedrius", "Florence", "Floridas", "Galardoun",
            "Garnish", "Gerin", "Gauter", "Gherard", "Gilbert", "Gilmere",
            "Goneries", "Gracian", "Gumret", "Guy", "Gwinas", "Harsouse", "Harvis",
            "Hebes", "Hemison", "Herawd", "Heringdale", "Herlews", "Hermel", "Hermind",
            "Hervis", "Hewgon", "Idres", "Jordans", "Lardans", "Leomie",
            "Manasan", "Maurel", "Melion", "Miles", "Morganor", "Morians",
            "Moris", "Nanowne", "Nerovens", "Pedivere", "Pellandres", "Pellogres",
            "Perin", "Phelot", "Pillounes", "Plaine", "Plenorias", "Sauseise", "Selises",
            "Selivant", "Semond"],
        femalename: ["Ade", "Alis", "Arnive", "Astrigis", "Bene", "Blancheflor", "Carsenefide",
            "Calire", "Cunneware", "Diane", "Elidis", "Enide", "Elizabeth", "Esclarmonde",
            "Feimurgan", "Felelolie", "Felinete", "Feunete", "Florie",
            "Gloris", "Heliap", "Iblis", "Idain", "Imane", "Jeschute", "Laufamour",
            "Liaze", "Lore", "Loorette", "Laudine", "Malvis", "Maugalie", "Melior",
            "Morchades", "Obie", "Obilot", "Oruale", "Repanse", "Sangive", "Tanree",
            "Tryamour", "Violette"],
        epithets: ['the Foul','the Mad','of the Sword','the Accursed','the Bald','the Beautiful','the Black','the Bold','the Brave','the Chaste','the Cruel','the Rose','the Eager',
            'the Fair','Farstrider','the Fat','the Fearless','the Fortunate','the Generous','the Good','the Giant','the Grim','the Hairy',
            'the Handsome','the Hermit','the Holy','the Just','the Lame','the Learned','the Lion','the Monk','the Little','the Elder','the Younger',
            'the Lucky','the Mad','the Kind','the Merciful','the Mighty','the Mild','the Pious','the Proud','the Prudent',
            'the Rash','the Red','the Short','the Silent','the Simple','the Small','the Steadfast','the Stout','the Strict','the Strong',
            'the Tall','the Terrible','the Valiant','the White','the Wise','the Wild', 'of Salisbury','the Briton','de Logres', 'de Sarum', 'Caer Caradduc',
            'the Energetic','the Forgiving','the Honest','the Modest','the Prudent','the Spiritual','the Pagan','the Temperate','the Trusting','the Valorous',
            'the Lusty','the Sloth','the Dragon','the Bear','the Owl','the Stag','the Vengeful','the Cruel','the Viper','the Reckless','the Worldly', 'the Malordorous',
            'the Brute','the Lithe','the Monk','the Quick','the Strong','the Ox','the Griffon','the Vain','the Passionate','the Loyal','the Cymric',
            'the One-Eyed','the Thin','the Brawny','the Fat','of the Shield','the Fox'],
		extendedNames: {
            suffix: ['ian','in','el','on','ens','ein','ians','ade','old','es','ouse','is','ert','ere','ind','ot','e','ond','ot','ies','ard','ews','ause','aunt'],
            mids: ['a','e','ec','an','el','tel','rem','er','in','iv','ow','as','ed'],
            prefix: ['Ad','Al','An','Arch','Arn','Arr','Band','Bell','Ber','Bl','Bre','Caul','Chest','Cleg','Cler','Dal','Din','Dr','Eb','Ed','El','Em','Flann','Flor','Gal',
                'Gar','Ger','Gaut','Gher','Gil','Gon','Grac','Gum','Gwin','Har','Heb','Hem','Her','Hewg','Hew','Id','Jord','Lard','Leom','Leon','Man','Maur','Mel','Mil','Mor',
                'Nan','Ner','Ped','Pell','Per','Phel','Pill','Pl','Plen','Saus','Sel','Sem','Tel','Thel','Wa','Wor','Tim']
        },
		deaths: {
			'Illness': {
				Male: ['died of the flux (dysentery)','died of consumption (tuberculosis)','died from congenital issues', 'died of the sweating sickness (influenza)', 'died of infection'],
				Female: ['died of the flux (dysentery)','died of consumption (tuberculosis)','died of the congenital issues', 'died of the sweating sickness (influenza)', 'died of infection']
			},
			'Natural': {
				Male: ['died of natural causes'],
				Female: ['died of natural causes']
			},
			'Other': { 
				Male: ['died of suicide','was poisoned and died','drowned', 'died of exposure', 'died of exposure', 'died of alcoholism','died in a household accident','died in a household accident','died in a hunting accident','died in a hunting accident','died in a hunting accident','died in a riding accident','died in a riding accident','died in a riding accident','died of foul magic','died of foul magic','died of foul magic','went missing and was never found','was found dead with no known cause','was found dead with no known cause'],
				Female: ['died of suicide','died of suicide','was poisoned and died','drowned', 'died of exposure', 'died of alcoholism','died in a household accident','died in a household accident','died in a household accident','died in a household accident','died in a household accident','died in a household accident','died in a riding accident','died in a riding accident','died of foul magic','died of foul magic','died of foul magic','went missing and was never found','was found dead with no known cause','was found dead with no known cause']
			},
			'Violence': {
				Male: ['died of the flux (dysentery)','died of consumption (tuberculosis)','died of the congenital issues', 'died of the sweating sickness (influenza)', 'died of infection'],
				Female: ['murdered by her husband','murdered by her husband','found murdered','murdered by a family member','mudered by bandits while traveling', 'mudered by bandits while traveling','died of pregnancy complications', 'died of pregnancy complications','died of pregnancy complications','died of pregnancy complications','died of pregnancy complications','died of pregnancy complications','died in childbirth','died in childbirth','died in childbirth','died in childbirth','died in childbirth','died in childbirth','died in childbirth','died in childbirth']
			}
		}
	},
	familydata : {
        ggfather : {
            deathyear: 0,
            glory: 0,
            name: ''
        },
        gfather : {
            birthyear: 0,
            deathyear: 0,
            knightyear: 0,
            name: ''
        },
        father : {
            
        },
        birthYear: 465,
		currentYear: 485,
		squireAge: 14,
        manor: {
            name: '',
            oldKnights: 0,
            midKnights: 0,
            youngKnights: 0,
            lineageFighters: 0,
            levy: 0
        },
        extendedFamily: {
            fathersSide: {
				ggfather: [],
				gfather: [],
				father: [],
				mother: [],
				uncles: [], //by blood
				aunts: [], //by blood
				sisters: [],
				brothers: [],
				cousins: [],
				relativesByMarriage: []
			},
			mothersSide: {
				mother: [],
				uncles: [], //by blood
				aunts: [], //by blood
				sisters: [],
				brothers: [],
				cousins: [],
				relativesByMarriage: []
			}
        },
		familyhistory: {
			historybyyear: []
		},
        template: {
            name: '',
            id: '2.440.jon', //gen, birth name
            dad: '2.440.jon', //or spouse
            birthyear: 0,
            deathyear: 0,
            gender: 'male',
            bastard: false,
            spousename: '',
            spousebirthyear: 0,
            spousedeathyear: 0
        }
    },
    randomRoll: function (sides, dice, mod) {
        var total = 0,
                roll;
        //$('#log').append('Roll '+die+'d6 + '+mod);
        for (; dice > 0; dice--) {
            roll = Math.floor((Math.random() * sides) + 1);
            //$('#log').append(' = '+ roll);
            total = total + roll;
        }
        total = total + mod;
        //$('#log').append('+ ' + mod + ' = result = '+ total +'');
        return total;
    },
    randomSelection: function (dataSet) {
        var setLength = dataSet.length;
        var roll = pendragonWinterPhase.randomRoll(setLength, 1, -1);
        return dataSet[roll];
    },
	sortByProperty: function (objArray, prop, direction){
		if (arguments.length<2) throw new Error("ARRAY, AND OBJECT PROPERTY MINIMUM ARGUMENTS, OPTIONAL DIRECTION");
		if (!Array.isArray(objArray)) throw new Error("FIRST ARGUMENT NOT AN ARRAY");
		const clone = objArray.slice(0);
		const direct = arguments.length>2 ? arguments[2] : 1; //Default to ascending
		const propPath = (prop.constructor===Array) ? prop : prop.split(".");
		clone.sort(function(a,b){
			for (let p in propPath){
					if (a[propPath[p]] && b[propPath[p]]){
						a = a[propPath[p]];
						b = b[propPath[p]];
					}
			}
			// convert numeric strings to integers
			a = a.match(/^\d+$/) ? +a : a;
			b = b.match(/^\d+$/) ? +b : b;
			return ( (a < b) ? -1*direct : ((a > b) ? 1*direct : 0) );
		});
		return clone;
	},
	extendedNameGenerator: function () {
        var nameData = pendragonWinterPhase.data.extendedNames;
        var prefix = pendragonWinterPhase.randomSelection(nameData.prefix);
        var mid = pendragonWinterPhase.randomSelection(nameData.mids);
        var suffix = pendragonWinterPhase.randomSelection(nameData.suffix);
        var newName = '';
        if (pendragonWinterPhase.randomRoll(6,1,0)===6) {
            newName=prefix+mid+suffix;
        } else {
            newName=prefix+suffix;
        }
        return newName;
    },
	appendTimeline: function (year, desc, family) {
        var yearText = year.toString();
        var timeline = $('#timeline');
        var famClass= (family)?' class="family"':'';
        timeline.append('<small'+famClass+'><b>'+yearText+' A. D.</b> -- '+desc+'</small><br>');
		
    },
	appendLog: function (message) {
        $('.eventlog').append('<p><small>'+message+'</small></p>');
    },
	initPendragonWinter: function () {
		pendragonWinterPhase.importFamily();
        pendragonWinterPhase.updateAge();
		pendragonWinterPhase.createSquire();
		pendragonWinterPhase.initFamilyTable();
		pendragonWinterPhase.drawInitialTree();
		pendragonWinterPhase.copytree();
        $('#advanceYear').on('click', function() {
			$('#currentYearPanel').html('');
            pendragonWinterPhase.advanceYear();
        });

    },
	importFamily: function() {
		var familyMembers = dataimport.exportData;
		var familyEvents = dataimport.familyhistory.historybyyear;
		pendragonWinterPhase.familydata.ggfather = dataimport.ggfather;
		pendragonWinterPhase.familydata.gfather = dataimport.gfather;
		pendragonWinterPhase.familydata.father = dataimport.father;
		pendragonWinterPhase.familydata.manor = dataimport.manor;
		pendragonWinterPhase.familydata.yourAge = dataimport.ggfather;

		pendragonWinterPhase.familydata.familyhistory = dataimport.familyhistory
		pendragonWinterPhase.initManor();
		$.each(familyEvents, function(index, key) {
			var combinedText = key[1];
			if (key[2] !== '') {combinedText = combinedText + '<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + key[2];}
			pendragonWinterPhase.appendTimeline(key[0],combinedText,false);
		});
		
		
	},
	initManor: function () {
		var manor = pendragonWinterPhase.familydata.manor;
		$('#manorData').append('<h3>'+manor.name+'</h3>');
		$('#manorData').append('<p>Your manor has an army of '+manor.oldKnights+' old knights, '+manor.midKnights+
            ' middle aged knights and '+manor.youngKnights+' young knights for a total of '+manor.totalKnights+
            ' fighting knights (detailed in family).  You can also call on '+manor.lineageMen+
            ' able bodied family members and a levy of '+manor.levy+' men.</p>');
	},
	initFamilyTable: function () {
		const family = dataimport.exportData;
		for (let member in family) {
			let info = family[member];
			let classString = '';
			//parse data Id
			// Fam ID is [GENDER M/F][BASTARD T/F][KNIGHT T/F][YEARBORN 000]
			let gender = (member.substring(0, 1) == 'F')? 'Female':'Male';
			let bastard = member.substring(1, 2);
			let knight = member.substring(2, 3);
			let age = pendragonWinterPhase.familydata.currentYear - info.birth;
			let mother = (info.motherID != 'M1' && info.motherID != 0 && info.motherID != '')?info.motherID.slice(6):'';
			let father = (info.fatherID != 'M1' && info.fatherID != 0 && info.fatherID != '')?info.fatherID.slice(6):'';
			let spouse = (info.spouse != 'M1' && info.spouse != 0 && info.spouse != '')?info.spouse.slice(6):'';
			let name = info.name + ' ' + info.title;
			var underageChildren = [];
			//let relation = pendragonWinterPhase.computeRelation(info, gender);
			//let relation = info.relationship;
			let tableRow = '';
			
			if (bastard == 'T') {
				gender = gender + ' (Bastard)';
				mother = '';
			}
			if (info.death != '') {
				classString = 'dead';
				age = info.death - info.birth;
				name = name + ' <img src="images/skull.png" />';
			}
			if (mother == 'other') {mother = 'Maternal Grandmother';}
			if (father == 'ather') {father = 'Maternal Grandfather';}
			tableRow = '<tr class="'+classString+'" id="tablerow-'+member+'"><td class="namecell">'+name+'</td><td>'+gender+'</td><td class="tableRelationCell"></td><td class="agecell">'+age+'</td><td>'+info.birth+'</td><td class="deathcell">'+info.death+'</td><td>'+mother+'</td><td>'+father+'</td><td>'+spouse+'</td></tr>';
			if (gender === 'Female' && spouse != '' && info.death  == '') {
				underageChildren = pendragonWinterPhase.computeUnderageChildrenAtStart(info);
				pendragonWinterPhase.appendLog(info.name + ' has kids');
				//pendragonWinterPhase.appendLog(underageChildren)
			}
			if (knight == 'N') {
				$('tbody.others').append(tableRow);
			} else {
				$('tbody.knights').append(tableRow);
			}
		}
	},
	computeUnderageChildrenAtStart: function (info) {
		let hasSpouse = (info.spouse != 0 && info.spouse != '');
		let age = pendragonWinterPhase.familydata.currentYear - info.birth;
		let baseChance = 0.9875;
		var childYears = age - 15;
		var childArray = [];
		
		if (childYears > 15) {childYears=15;}
		for (childYears; childYears>0; childYears--) {
			var firstRoll = pendragonWinterPhase.randomRoll(20,1,0);
			if (firstRoll <= 9) { //bob addababy 
				var currentChance = baseChance ** childYears;
				var percentageRoll = pendragonWinterPhase.randomRoll(100,1,0);
				currentChance=currentChance*100;
				if (percentageRoll < currentChance) { //it lived
					var gender = (pendragonWinterPhase.randomRoll(20,1,0) <=10)? 'Boy':'Girl';
					//childArray.push(childYears + ' year old ' + gender);
				}
			}
		}
		return childArray;
	},
	drawInitialTree: function () {
		var family = dataimport.exportData;
		var sortingArray = [];
		var recordedArray = [];
		//const resultsByObjectId = pendragonWinterPhase.sortByProperty(family, 'birth.OBJECTID');
		//family.sort((a, b) => (a.birth > b.birth) ? 1 : -1);
		for (let member in family) {
			sortingArray.push(family[member]);
			
		}
		sortingArray.sort((a, b) => (a.birth < b.birth) ? 1 : -1);
		sortingArray.sort((a, b) => (a.fatherID === 0) ? 1 : -1);
		console.log(sortingArray);
		//while testing
		$('.firstgen').show();
		
		for (var i = 0; i < sortingArray.length; i++) {
		//for (let member in family) {
			let info = sortingArray[i];
			let member = info.id;
			let markup;
			let gender = (member.substring(0, 1) == 'F')? 'Female':'Male';
			let bastard = member.substring(1, 2);
			let knight = member.substring(2, 3);
			let hasMother = (info.motherID != 'M1' && info.motherID != 0 && info.motherID != '');
			let hasFather = (info.fatherID != 'M2' && info.fatherID != 0 && info.fatherID != '');
			let isFirstGen = (info.fatherID == 'M2');
			//let isMaternal = (info.fatherID == 'Grandfather');
			let hasSpouse = (info.spouse != 0 && info.spouse != '');
			let isSpouse = (hasSpouse && !hasFather && !hasMother);
			let byMarriage = (hasSpouse && !hasFather && !isFirstGen);
			let computeTargetBranch = pendragonWinterPhase.computeTargetBranch(info);
			let targetBranch = computeTargetBranch[0];
			let newBranch = computeTargetBranch[1];
			
			
			markup = pendragonWinterPhase.createTreeMemberMarkup(info, byMarriage, newBranch);
			recordedArray.push(info.id);
			
			if (targetBranch !== '') {
				if (hasSpouse) {
					$('#family-tree').find(targetBranch).addClass('married');
					if (isSpouse) {
						$('#family-tree').find(targetBranch).append(markup);
						
					} else {
						$('#family-tree').find(targetBranch).prepend(markup);
						
					}
					
				}  else {
					$('#family-tree').find(targetBranch).append(markup);
				}
				if (!isSpouse || isFirstGen) {

				}
			}
			

		}
	},
	createTreeMemberMarkup: function (member, byMarriage, newBranch) {
		var markup = treeMemberMarkup;
		let gender = (member.id.substring(0, 1) == 'F')? 'female':'male';
		let bastard = member.id.substring(1, 2);
		let knight = member.id.substring(2, 3);
		let isDead  = (member.death != '');
		let styleClass = gender;
		
		if (isDead) {
			styleClass = styleClass + ' deceased';
		}
		if (newBranch) {
			if (member.spouse != 0) {
				markup = '<li data-birth="[birth]" data-hoh="'+member.id+'"><div class="couple" id="couple-'+member.id+'">' + markup + '</div></li>';
			} else {
				markup = '<li data-birth="[birth]" data-hoh="'+member.id+'"><div>' + markup + '</div></li>';
			}	
		}
		
		if (knight == 'K') {
			styleClass = styleClass + ' knight';
		}
		if (bastard == 'T') {
			
			styleClass = styleClass + ' bastard';
		}
		
		markup=markup.replace('[id]',member.id);
		markup=markup.replace('[individualClass]',styleClass);
		markup=markup.replace('[name]',member.name);
		markup=markup.replace('[title]',member.title);
		markup=markup.replace(/\[birth\]/g,member.birth);
		markup=markup.replace('[death]',member.death);
		//markup=markup.replace('[relation]',member.relationship);
		
		return markup;
	},
	computeTargetBranch: function(info) {
		//determines where to put them in the tree and updates the family member table with relationship
		let hasMother = (info.motherID != 'M1' && info.motherID != 0 && info.motherID != '');
		let hasFather = (info.fatherID != 'M2' && info.fatherID != 0 && info.fatherID != '');
		let isFirstGen = (info.fatherID != 'M2');
		let isMaternal = (info.fatherID == 'Grandfather');
		let hasSpouse = (info.spouse != 0 && info.spouse != '');
		let isSpouse = (hasSpouse && !hasFather && !hasMother);
		let parentID = (!hasFather && hasMother)?info.motherID:info.fatherID;
		let gender = info.id.substring(0, 1);
		let bastard = info.id.substring(1, 2);
		let tableRelationCell = $('tr#tablerow-'+info.id+' td.tableRelationCell');
		var relationship='';
		var targetSelector = '';
		var newBranch = false;
		
		if (info.relationship =='Great grandfather') {
			targetSelector = '.greatgrandfather';
			relationship=info.relationship;
			pendragonWinterPhase.familydata.ggfather['id'] = info.id;
			$('#family-tree').find(targetSelector).parent('li').attr({
				'data-hoh':info.id,
				'data-birth':info.birth
			});

		} else if (info.relationship =='Grandfather') {
			targetSelector = '.grandfather';
			relationship=info.relationship;
			$('#family-tree').find(targetSelector).parent('li').attr({
				'data-hoh':info.id,
				'data-birth':info.birth
			});
			
		} else if (info.relationship =='father') {
			targetSelector = '.father';
			relationship='Father';
			pendragonWinterPhase.familydata.father['id'] = info.id;
			$('#family-tree').find(targetSelector).parent('li').attr({
				'data-hoh':info.id,
				'data-birth':info.birth
			});
			
		} else if (info.relationship == 'mother') {
			targetSelector = '.mother';
			relationship='Mother';
		} else if (info.fatherID == 'Grandfather') {
			targetSelector = '.motherthirdgen';
			newBranch=true;
			relationship='Maternal ';
			if (gender == 'M') {
				relationship = relationship + 'Uncle';
				
			} else {
				relationship = relationship + 'Aunt';
			}
		} 
		else if (isSpouse) {
			if (info.relationship =='Great grandmother') {
				relationship=info.relationship;
				targetSelector = '.greatgrandfather';
			} else if (info.relationship =='Grandmother') {
				relationship=info.relationship;
				targetSelector = '.grandfather';
			} else {
				
				if ($('#'+info.spouse).length != 0) {
					relationship = 'Spouse of ' + dataimport.exportData[info.spouse].name;
					targetSelector = '#couple-' + info.spouse;
				}
			}
			
		} else {
			targetSelector = 'li[data-hoh="'+parentID+'"] > ul';
			newBranch=true;
			//wonky hack - if the child tree doesn't exist, we create it
			if (parentID == pendragonWinterPhase.familydata.father['id']) {
				if (gender == 'M') {
					if (bastard == "T") {
						relationship = relationship + 'Half-';
					}
					relationship = relationship + 'Brother';
					
				} else {
					relationship = relationship + 'Sister';
				}
			} else if (parentID == pendragonWinterPhase.familydata.ggfather['id']) {
				relationship = relationship + 'Great Uncle';
			} else {
				relationship = relationship + 'Cousin';
			}
			if ($(targetSelector).length == 0 
			  && $('li[data-hoh="'+parentID+'"]').length != 0) {
				$('li[data-hoh="'+parentID+'"]').append('<ul></ul>');
				
			}
		}
		
		
		
		if ($('#family-tree').find(targetSelector).length != 0) {
			pendragonWinterPhase.appendLog('put on tree : '+info.birth + ' ' + info.name + ' parent is ' + parentID);
		} else {
			pendragonWinterPhase.appendLog('NOT put '+info.birth + ' ' + info.name + '  parent is ' + parentID + ' selector is ' + targetSelector);
		}
		
		tableRelationCell.html(relationship);
		return [targetSelector, newBranch];
		
	},
	copytree: function () {
        var originalTree = $('.yourgen').first().html();
		
		$('.mother span.female').clone().appendTo('.father');
		$('.father span.male').clone().appendTo('.mother');
        $('.mother').next('ul.yourgen').html(originalTree);
		
		
		$('#family-tree span.married').next('span').addClass('spouse');
        $('.firstgen').show();
        
        $('.mothertree').hide();
        $('#showMotherTree').on('click', function (e) {
            e.preventDefault();
            $('.mothertree').show();
            $('.firstgen:visible').hide();
        });
        $('#showFatherTree').on('click', function (e) {
            e.preventDefault();
            $('.mothertree:visible').hide();
            $('.firstgen').show();
        });
    },
	updateAge: function () {
		var ageText = $('#characterAge');
		var age = pendragonWinterPhase.familydata.currentYear - pendragonWinterPhase.familydata.birthYear;
		const affectedRows = $('#family tr').not('.dead');
		
		//update family too
		affectedRows.each(function (index) {
			var currentAge = Number($(this).find('.agecell').text());
			currentAge++;
			$(this).find('.agecell').html(currentAge);
		});
		
		ageText.html(age);
		$('#campaignyear').html(pendragonWinterPhase.familydata.currentYear);
		
		if (age >= 35) {
			pendragonWinterPhase.rollForAging();
		}
	},
	rollForAging() {
		var results = [0,0, 4, 3, 2, 1, 0, 0, 0, 1, 2, 3, 4];
		var attributes = ["SIZ", "DEX", "STR", "CON", "APP", "NONE"];
		var rollValue = pendragonWinterPhase.randomRoll(6,1,0);
		var resultCount = results[rollValue];
        var affectedAttrs = [];
		var setLength = 6;
		$('#currentYearPanel').append('<p>' + results[rollValue] + ' affected</p>');
		for (; resultCount > 0; resultCount--) {
			var singleRoll = pendragonWinterPhase.randomRoll(setLength, 1, -1);
			if (singleRoll !== 6) {
				affectedAttrs.push(attributes[singleRoll]);
			}
        }
		$('#currentYearPanel').append('<p>' + affectedAttrs + ' affected</p>');
		
	},
	createSquire() {
		var squireName = pendragonWinterPhase.randomSelection(pendragonWinterPhase.data.name);
		var table = $('#squires tbody');
		table.find('tr.active').removeClass('active');
		table.append('<tr class="active"><td>'+squireName+'</td><td><span class="squireAge">14</span></td></tr>');
	},
	advanceYear() {
		var squireAge = pendragonWinterPhase.familydata.squireAge+1;
		//update ages
		
		pendragonWinterPhase.familydata.currentYear = pendragonWinterPhase.familydata.currentYear+1;
		pendragonWinterPhase.updateAge();
		pendragonWinterPhase.horseCheck();
		pendragonWinterPhase.kinEvent();
		pendragonWinterPhase.birthDeathMarriage();
		
		if (squireAge > 21) {
			$('#squires .active .squireAge').html('retired ('+pendragonWinterPhase.familydata.currentYear+')');
			pendragonWinterPhase.createSquire();
			pendragonWinterPhase.familydata.squireAge = 14;
			
		} else {
			pendragonWinterPhase.familydata.squireAge=squireAge;
			$('#squires .active .squireAge').html(squireAge);
		}
		
		
	},
	horseCheck () {
		var deadCount = 0;
		$('#horses .horsestable tr').each(function (index) {
			
			var horseCountCell = $(this).find('.horsecount');
			var horseCount = Number(horseCountCell.text());
			var horseType = $(this).find('.horsetype').text();
			
			for (; horseCount > 0; horseCount--) {
				var theRoll = pendragonWinterPhase.randomRoll(6,1,0);
				var isDead = (theRoll < 3);
				if (isDead) {
					deadCount++; 
					
					if (deadCount>1) {
						var currentCount = Number(horseCountCell.text());
						currentCount=currentCount-1;
						$('#currentYearPanel').append('<p>A ' + horseType + ' passed away.</p>');
						horseCountCell.html(currentCount);
						
					} else {
						$('#currentYearPanel').append('<p>A ' + horseType + ' passed away but was replaced.</p>');
					}
				}
			}	
		});
		if (deadCount > 1) {
			deadCount=deadCount-1;
			$('#currentYearPanel').append('<p>You lost '+deadCount+' horses.</p>');
		}
		
	},
	kinEvent: function() {
		var roll = pendragonWinterPhase.randomRoll(20,1,0);
		var kinSet = [];
		var messages = ['',
			'Would be in law refuse to marry kin daughter after rumors, select one; add 2£ to dowry=Generous & Humble, defend her name in a duel=Proud & Honor, find a new match=Energetic & Love, find out the truth= Family -3 and Just & Honest, take it to court=½£ Loyalty & Courtesy',
			'Arrange a marriage, select one; Selfish to gain 2d6£, Prudent to gain kin knight, or Honor',
			'Disaster when kin is mustered for battle. Roll on Kin knight muster',
			'Kin leader gains a Luck roll, this is given by kin for the betterment of the kin',
			'Kin needs help with dowry, select one; Refuse=Family -3, pay 1£=Generous, pay£=Honor',
			'Kin become a squire. Each winter roll 1d6, [1] he died in battle [6] he became a knight',
			'Kin member asks you to claim his bastard as your own, Yes = Love Family, No = Honor',
			'Kin wed above their stature gain one kin knight, [14] young [5] middle aged [6] old',
			'Roll for Scandal in Kin, if you are knighted you can champion for your kin\'s good name',
			'Select kin knight that leaves on quest for d6 years, he gets 2£ &00 glory/year and then return',
			'Kin needs a champion (Duel) to resolve a dispute after a fight; Yes = Honor, No = -1 lineage men',
			'You as warden decides the marriage of a landed widow with only a daughter, select one; selfish+1 to marry her yourself, Love Family & Proud for kin member, or +1 honor for the right choice',
			'Roll 1d6 if less than the number of middle aged knights then one is killed, otherwise gain Loot',
			'Underage kin member receive land gift of 3£ per annum, you are warden for 2d6 years',
			'Shelter from vengeance, select which gets -1 the other get 3; Love Family, Honor, or Loyalty Lord',
			'Kin young show promise, select one; +1 lineage men, take a squire, or for 1£ add 1d6 lineage men',
			'Youngling in kin asks you to help him become a squire, Yes = Love Family, No = Temperate',
			'Kin widow and orphans need shelter at ½£ per winter, select one; Refuse=Family -1, Arrange her marriage= Pious & Proud or Prudent & Selfish, Shelter her yourself=Generous & Family and each winter roll 1d6; [1] the sons become +1d6 lineage men [6] 2£ goods stolen & Suspicious',
			'Eldest notable kin dies, if no direct heir then kin leader inherits, roll Luck if unknown inheritance',
			'Inspire your kin, for each success and +1 lineage man; Orate, Compose, Sing and Play'];
			var selectedMessage = messages[roll];
			$('#currentYearPanel').append('<p>'+ selectedMessage+'</p>');
			
			//TODO randomly select kin amd insert in message
	},
	getBachelors: function(requestedGender) { //male female both
		const family = dataimport.exportData;
		var workingSet = [];
		for (let member in family) {
			let info = family[member];
			let gender = (member.substring(0, 1) == 'F')? 'Female':'Male';
			let age = pendragonWinterPhase.familydata.currentYear - info.birth;
			let isAlive = (info.death == '');
			let spouse = (info.spouse != 'M1' && info.spouse != 0 && info.spouse != '')?info.spouse.slice(6):'';
			let hasSpouse = (spouse != '');
			
			if (hasSpouse) {
				if (family[info.spouse].death != '') {
					hasSpouse=false;
				}
			}
			
			if (age >=16 && isAlive && hasSpouse) {
				if (requestedGender==gender || requestedGender == 'Both') {
					workingSet.push(member);
				}
			}
		}
		return workingSet;
	},
	getKin: function(requestKnight, requestedAge, requestedGender) {
		const family = dataimport.exportData;
		var workingSet = [];
		for (let member in family) {
			let info = family[member];
			let gender = (member.substring(0, 1) == 'F')? 'Female':'Male';
			let age = pendragonWinterPhase.familydata.currentYear - info.birth;
			let isAlive = (info.death == '');
			let knight = member.substring(2, 3);
			if (age >= requestedAge && isAlive) {
				if (requestedGender == gender || requestedGender == 'Both') {
					if (requestKnight && knight=='K') {
						workingSet.push(member);
					} else if (!requestKnight && knight != 'K') {
						workingSet.push(member);
					} else if (requestKnight == 'Either')  {
						workingSet.push(member);
					}	
				}
			}
		}
		return workingSet;
	},
	birthDeathMarriage: function  () {
		const family = dataimport.exportData;
		var weddings = 0;
		for (let member in family) {
			//skip clan deserters
			if ($('#'+ family[member].id).closest('div').hasClass('leftclan') == false) {
				let info = family[member];
				let gender = (member.substring(0, 1) == 'F')? 'Female':'Male';
				let age = pendragonWinterPhase.familydata.currentYear - info.birth;
				let isAlive = (info.death == '');
				let spouse = (info.spouse != 'M1' && info.spouse != 0 && info.spouse != '')?info.spouse.slice(6):'';
				let isBirthAge = (age >= 15 && age <= 40);
				let canBirth = (spouse != '' && isAlive && gender == 'Female' && isBirthAge);
				let canMarry = (spouse == '' && isAlive && age >= 16  && age < 55);			
				var logMessage = info.name;
				//limit to 2 weddings and ban the recently departed
				
				
				let spouseDead = false;
				if (info.spouse != '') {
					//console.log(info);
					if (family[info.spouse].death != '') {
						spouseDead = true;
					}
				}
				if (canBirth) {  //death and pregnancy of married women	
					logMessage=logMessage+ ' can die';
					logMessage=logMessage+ ' and can get prenant';
					pendragonWinterPhase.birthCheck(info);
				} else if (isAlive) {
					logMessage=logMessage+ ' can die';
					isAlive = !(pendragonWinterPhase.killKin(age, gender, !canMarry, info.name, info.id));
					if (canBirth && isAlive) {
						logMessage=logMessage+ ' and can get prenant';
					}
					if (canMarry && isAlive) {
						var foundSpouseRoll = pendragonWinterPhase.randomRoll(20,1,0);
						var check = (age - 15)/2;
						if (spouseDead) {
							logMessage=logMessage+ ' and can get remarried (rolls ' + foundSpouseRoll + ' against ' + check + ') ';
						} else {
							logMessage=logMessage+ ' and can get married (rolls ' + foundSpouseRoll + ' against ' + check + ') ';

						}
						
						if (check >= foundSpouseRoll && weddings < 2) {
							weddings++;
							pendragonWinterPhase.createSpouse(info, spouseDead);
							
							logMessage=logMessage+ ' and gets married';
						}
					}
					pendragonWinterPhase.appendLog(logMessage);
				}
				
			}
		}
	},
	createSpouse: function (info, spouseDead) {
		let name = pendragonWinterPhase.extendedNameGenerator();
		let age = pendragonWinterPhase.randomRoll(20,2,0)+14;
		let gender = (info.id.substring(0, 1) == 'F')? 'Male':'Female';
		let birth = Number(pendragonWinterPhase.familydata.currentYear) - age;
		let spouse = info.id;
		var treeMemberMarkup, tablerow;
		var id = (info.id.substring(0, 1) == 'F')? 'M':'F';
		var isKnight = (id=='M');
		var knightRoll = pendragonWinterPhase.randomRoll(6,1,0);
		var leavesClan = false;
		
		id = id + 'FN' + birth + name;
		if (knightRoll > 2  || !isKnight) {
			isKnight=false;
		} else {
			name = 'Sir ' + name;
			id = 'MFK' + birth + name;
			
			// 50% of the times, wives should join the other family
			if (pendragonWinterPhase.randomRoll(6,1,0) > 3) {
				leavesClan = true;
			}
		}
		
		
		let record = {
			"id":id,
			"name":name,
			"title":"",
			"birth":birth,
			"death":"",
			"spouse":spouse,
			"fatherID":0,
			"motherID":0,
			"relationship":"Spouse of " + info.name
		}
		dataimport.exportData[id] = record;
		dataimport.exportData[info.id].spouse = id;
		treeMemberMarkup = pendragonWinterPhase.createTreeMemberMarkup(record, true, false);
		$('#family-tree').find('#'+spouse).after(treeMemberMarkup);
		
		$('#family-tree').find('#'+spouse).parent('div').addClass('married');
		
		
		if (leavesClan) {
			$('#family-tree').find('#'+spouse).parent('div').addClass('leftclan');
		}
		
		
		tableRow = '<tr id="tablerow-'+id+'"><td class="namecell">'+name+'</td><td>'+gender+'</td><td class="tableRelationCell">Spouse of '+info.name+'</td><td class="agecell">'+age+'</td><td>'+birth+'</td><td class="deathcell"></td><td></td><td></td><td>'+info.name+'</td></tr>';
		
		if (isKnight) {
			$('tbody.knights').append(tableRow);
		} else {
			$('tbody.others').append(tableRow);
		}
		if (spouseDead) {
			$('#currentYearPanel').append('<p><b>' +info.name+ '</b> got remarried. Their new spouse is <b>'+name+'</b> who has been added to your clan.</p>');
		} else {
			$('#currentYearPanel').append('<p><b>' +info.name+ '</b> was married to <b>'+name+'</b> who has been added to your clan.</p>');
		}
		if (leavesClan) {
			$('#currentYearPanel').append('<p><b>' +info.name+ '</b> leaves the clan.</p>');
		}

		pendragonWinterPhase.appendTimeline (pendragonWinterPhase.familydata.currentYear, info.name+ ' married '+name, false);
	},
	killKin: function (age, gender, married, name, id) {
		let currentYear = pendragonWinterPhase.familydata.currentYear;
		var firstRoll = pendragonWinterPhase.randomRoll(20,1,0);
		var secondRoll = pendragonWinterPhase.randomRoll(20,1,0);
		var causeRoll = pendragonWinterPhase.randomRoll(6,1,0);
		var died = false;
		var reasonText, reasonIndex;
		if (age == 1 && firstRoll <= 2) { //infants
			died=true;
			reasonIndex='Illness';
		} else if (age > 1 && age <= 20) { //the young
			if (firstRoll == 1 && secondRoll <= 5) { //dead
				died=true;
				if (gender == 'Female') {
					if (causeRoll <= 4) {
						reasonIndex='Illness';
					} else {
						reasonIndex ='Other';
					}
				} else {
					//split men at 14, battle age
					if (age < 14) {
						if (causeRoll <= 4) {
							reasonIndex='Illness';
						} else {
							reasonIndex ='Other';
						}
					} else {
						if (causeRoll <= 3) {
							reasonIndex='Illness';
						} else if (causeRoll == 4 || causeRoll == 6) {
							reasonIndex ='Other';
						}else if (causeRoll == 6) {
							reasonIndex ='Violence';
						}
					}
				}	
			}
			
		} else if (age > 20 && age <= 45) {
			if (firstRoll==1 && secondRoll <+ 10) { //dead
				died=true;
				if (causeRoll == 1) {
					reasonIndex='Illness';
				} else if (causeRoll == 2) {
					reasonIndex='Natural';
				} else if (causeRoll == 3 || causeRoll == 4) {
					reasonIndex ='Other';
				} else {
					reasonIndex ='Violence';
				}
			} 
		} else if (age > 45 && age <= 65) {
			if (firstRoll==1) { //dead
			died=true;
				if (causeRoll == 1 || causeRoll == 2) {
					reasonIndex='Natural';
				} else if (causeRoll == 3 || causeRoll == 4) {
					reasonIndex ='Natural';
				} else if (causeRoll == 5) {
					reasonIndex ='Other';
				} else {
					reasonIndex ='Violence';
				}
			} 
		} else {
			if (firstRoll <= 4) { //dead
			died=true;
				if (causeRoll == 1 || causeRoll == 2) {
					reasonIndex='Natural';
				} else if (causeRoll == 3 || causeRoll == 4) {
					reasonIndex ='Natural';
				} else if (causeRoll == 5 && secondRoll <= 10) { //halving chance for violent end in over 65
					reasonIndex ='Violence';
				} else {
					reasonIndex ='Other';
				}
			}
		}
		if (died) {
			var dataDeathSet = pendragonWinterPhase.data.deaths[reasonIndex][gender];
			var deathReason = pendragonWinterPhase.randomSelection(dataDeathSet);
			
			
			if (!married && reasonIndex == 'Other' && gender == 'Female') {
				var deathRoll = pendragonWinterPhase.randomRoll(6,1,0);
				deathReason = pendragonWinterPhase.data.deaths.Other.Female[deathRoll]
			}
			
			pendragonWinterPhase.appendLog(name + ' ' + deathReason);
			$('#currentYearPanel').append('<p><b>'+name + '</b> ' + deathReason+'</p>');
			pendragonWinterPhase.appendTimeline(currentYear, name + ' '+deathReason, false);
			$('#family tr#tablerow-'+id).addClass('dead').find('td.namecell').append('&nbsp;<img src="images/skull.png">');
			$('#family tr#tablerow-'+id).find('.deathcell').html(currentYear);
			$('#family-tree span#'+id).addClass('deceased').find('.deathYear').html(currentYear);
			
			dataimport.exportData[id].death = currentYear;
			
		}
		return died;
	},
	birthCheck: function (info) {
		let currentYear = pendragonWinterPhase.familydata.currentYear;
		var firstRoll = pendragonWinterPhase.randomRoll(20,1,0);
		var secondRoll = pendragonWinterPhase.randomRoll(20,1,0);
		
		var causeRoll = pendragonWinterPhase.randomRoll(6,1,0);
		var died = false;
		var hadBaby = false;
		var twins = false;
		var reasonText, reasonIndex;
		var name, twinname;
		pendragonWinterPhase.appendLog('baby rolls for ' + info.name + ':  ' + firstRoll + ',' + secondRoll);
		
		
		if (firstRoll == 1 && secondRoll <=10 ) {
			died = true;
			pendragonWinterPhase.appendLog(info.name + ': dies instead  ');
			if (causeRoll == 1) {
				reasonIndex='Natural';
			} else if (causeRoll == 2) {
				reasonIndex ='Natural';
			} else if (causeRoll == 3  || causeRoll == 4) {
				reasonIndex ='Other';
			} else {
				reasonIndex ='Violence';
			}
		}
		
		if (!died && firstRoll >= 11) {
			if (firstRoll == 11) {
				if (secondRoll <= 10) {
					twins = true;
					hadBaby = true;
				} else {
					//mother dies baby lives
					died = true;
					hadBaby = true
				}
			} else {
				hadBaby = true;
			}
		}
		if (hadBaby) {
			name = pendragonWinterPhase.createChild(info);
			pendragonWinterPhase.appendLog(info.name + ': had a baby');
			if (twins) {
				twinname = pendragonWinterPhase.createChild(info);
				$('#currentYearPanel').append('<p><b>' +info.name+ '</b> had a twins, <b>'+name+'</b> and <b>'+twinname+'</b>, who have been added to your clan.</p>');
			} else {
				$('#currentYearPanel').append('<p><b>' +info.name+ '</b> had a baby, <b>'+name+'</b>, who has been added to your clan.</p>');
			}
			
		} else {
			pendragonWinterPhase.appendLog(info.name + ': no baby');
		}
	},
	createChild: function (info) {
		let name = pendragonWinterPhase.extendedNameGenerator();
		let age = 0;
		let gender = (pendragonWinterPhase.randomRoll(6,1,0) > 3)?'M':'F';
		let birth = pendragonWinterPhase.familydata.currentYear;
		let mother = info.id;
		let father = info.spouse;
		let fatherName = info.spouse.slice(6);
		var treeMemberMarkup, tablerow;
		var id = gender + 'FN' + birth + name;
		var targetBranch;
		
		let record = {
			"id":id,
			"name":name,
			"title":"",
			"birth":birth,
			"death":"",
			"spouse":info.spouse,
			"fatherID":father,
			"motherID":mother,
			"relationship":"Child of " + info.name
		}
		dataimport.exportData[id] = record;
		dataimport.exportData[info.id].mother = mother;
		dataimport.exportData[info.id].father = father;
		treeMemberMarkup = pendragonWinterPhase.createTreeMemberMarkup(record, false, true);
		targetBranch = $('#family-tree').find('#'+mother).closest('li[data-hoh]');
		
		if (targetBranch.find('ul').length ==0) {
			targetBranch.append('<ul></ul>');
		} 
		targetBranch.find('ul').append(treeMemberMarkup);
		
		tableRow = '<tr id="tablerow-'+id+'"><td class="namecell">'+name+'</td><td>'+gender+'</td><td class="tableRelationCell">Child of '+info.name+'</td><td class="agecell">'+age+'</td><td>'+birth+'</td><td class="deathcell"></td><td>'+info.name+'</td><td>'+fatherName+'</td><td></td></tr>';
		
		$('tbody.others').append(tableRow);

		pendragonWinterPhase.appendTimeline (pendragonWinterPhase.familydata.currentYear, info.name+ ' gave birth to '+name, false);
		return name;
		
	}
};